# Git Commit ルール

Git commitを作成する際のルールを定義します。

## 基本方針

コミットを作成する際は、以下の原則に従うこと：

1. **アトミックコミット**: 1つのコミットには1つの論理的な変更のみを含める
2. **明確なメッセージ**: 何を変更したか（What）だけでなく、なぜ変更したか（Why）も伝える
3. **プレフィックスの使用**: 変更の種類を示すプレフィックスを必ず付ける

## コミットメッセージの形式

### 基本構造

```
<プレフィックス>: <変更内容の簡潔な説明>

<詳細な説明（オプション）>

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

### 重要なルール

- **1行目**: プレフィックス + コロン + スペース + 簡潔な説明
- **簡潔性**: 1行目は50-72文字以内を目安にする
- **具体性**: 「修正」「変更」などの曖昧な表現を避け、具体的に記述する
- **言語**: 日本語または英語（プロジェクトの慣習に従う）
- **Co-Authored-By**: Claude Codeが関与した場合は必ず追加する

## プレフィックスの種類

### 主要なプレフィックス

- **`add:`** - 新機能、新ファイル、新しい設定の追加
  - 例: `add: ユーザー認証機能を追加`
  - 例: `add: rule for git-push`

- **`modify:`** - 既存機能の変更、拡張、更新
  - 例: `modify: ログイン画面のUIを改善`
  - 例: `modify: allow terraform fmt`

- **`fix:`** - バグ修正、不具合の解消
  - 例: `fix: ログアウト時のメモリリークを修正`
  - 例: `fix: vim起動時のhybridカラースキーム読み込みエラーを修正`

- **`remove:`** - ファイル、機能、コードの削除
  - 例: `remove: 非推奨のAPIエンドポイントを削除`
  - 例: `remove: 未使用のヘルパー関数を削除`

### 補助的なプレフィックス

- **`refactor:`** - 機能は変えずにコード構造を改善
  - 例: `refactor: 認証ロジックをモジュール化`

- **`docs:`** - ドキュメントのみの変更
  - 例: `docs: READMEにセットアップ手順を追加`

- **`test:`** - テストの追加、修正
  - 例: `test: ユーザー登録のE2Eテストを追加`

- **`style:`** - フォーマット、スタイルのみの変更（機能に影響しない）
  - 例: `style: コードのインデントを統一`

- **`chore:`** - ビルド設定、依存関係、ツール設定の変更
  - 例: `chore: package.jsonの依存関係を更新`

- **`perf:`** - パフォーマンス改善
  - 例: `perf: データベースクエリを最適化`

## 良いコミットメッセージの例

### 良い例 ✅

```
add: ユーザープロフィール編集機能を追加

ユーザーが自分のプロフィール情報（名前、メールアドレス、アバター）を
編集できる機能を実装しました。

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

```
fix: ログイン時のセッション期限切れエラーを修正

セッション期限が切れた際に適切なエラーメッセージが表示されず、
ユーザーが混乱する問題を修正しました。

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

```
modify: APIレスポンスのキャッシュ期間を延長

パフォーマンス改善のため、APIレスポンスのキャッシュ期間を
5分から15分に延長しました。

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

### 悪い例 ❌

```
修正
```
→ プレフィックスがなく、何を修正したか不明

```
add: 機能追加
```
→ どの機能を追加したか不明

```
いろいろ修正しました
```
→ プレフィックスがなく、内容が曖昧

## コミット作成の手順

### 1. 変更内容の確認

コミット前に必ず変更内容を確認する：

```bash
# ステータス確認
git status

# 変更差分の確認（ステージング前）
git diff

# ステージングした変更の確認
git diff --staged
```

### 2. ファイルのステージング

関連する変更のみをステージングする：

```bash
# 特定のファイルをステージング（推奨）
git add <file1> <file2>

# すべての変更をステージング（慎重に使用）
git add .
```

**重要**:
- 複数の異なる変更がある場合は、コミットを分割する
- 関連性のない変更を1つのコミットにまとめない
- 機密情報（.env、credentials等）を誤ってステージングしないよう注意

### 3. コミットの作成

HEREDOCを使用してコミットメッセージを作成する：

```bash
git commit -m "$(cat <<'EOF'
add: ユーザープロフィール編集機能を追加

ユーザーが自分のプロフィール情報を編集できる機能を実装。

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

### 4. コミット後の確認

```bash
# 最新のコミットを確認
git log -1

# コミット内容を確認
git show HEAD
```

## Git Safety Protocol

Claude Codeがコミットを作成する際の安全プロトコル：

### 禁止事項

- **NEVER**: git configを更新しない
- **NEVER**: 破壊的なgitコマンドを実行しない（明示的な指示がない限り）
  - `push --force`
  - `reset --hard`
  - `clean -f`
  - `branch -D`
- **NEVER**: hooksをスキップしない（`--no-verify`、`--no-gpg-sign`等）
- **NEVER**: main/masterへのforce pushを実行しない
- **CRITICAL**: 既存のコミットを修正せず、常に新しいコミットを作成する

### ステージングのベストプラクティス

- 具体的なファイル名を指定してステージングする（`git add -A`や`git add .`は避ける）
- 機密ファイル（.env、credentials）を誤ってステージングしない
- 大きなバイナリファイルを誤ってステージングしない

### コミット作成時の注意

- ユーザーが明示的に要求した場合のみコミットを作成する
- コミット作成前に必ず`git status`と`git diff`で変更内容を確認する
- コミットメッセージは検出された変更内容を正確に反映する

## コミット分割のガイドライン

複数の異なる変更がある場合は、コミットを分割することを検討する：

### 分割が推奨されるケース

1. **異なる関心事**: コードベースの無関係な部分への変更
2. **異なる種類の変更**: 機能追加、バグ修正、リファクタリングの混在
3. **ファイルパターン**: 異なる種類のファイルへの変更（ソースコードとドキュメント）
4. **論理的グループ化**: 別々に理解またはレビューした方が分かりやすい変更

### 分割の例

悪い例（1つのコミットに複数の変更）：
```
add: 機能追加といくつかの修正
```

良い例（複数のコミットに分割）：
```
1つ目: add: ユーザープロフィール編集機能を追加
2つ目: fix: ログイン画面のレイアウト崩れを修正
3つ目: docs: APIドキュメントを更新
```

## pre-commit hookが失敗した場合

pre-commit hookが失敗した場合の対応：

1. **問題を修正する**（推奨）
   - hookが指摘した問題を修正
   - 修正内容を再度ステージング
   - 新しいコミットを作成

2. **hookをスキップする**（ユーザーが明示的に要求した場合のみ）
   ```bash
   git commit --no-verify -m "commit message"
   ```

**重要**: hookが失敗した場合、`--amend`を使用しない。これは前のコミットを変更してしまうため、作業を失う可能性がある。

## 実装例

### 単一ファイルの変更をコミット

```bash
# 変更を確認
git status
git diff

# ファイルをステージング
git add src/components/UserProfile.tsx

# コミット作成
git commit -m "$(cat <<'EOF'
add: ユーザープロフィール編集機能を追加

ユーザーが自分のプロフィール情報を編集できる機能を実装。

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

### 複数のファイルをまとめてコミット

```bash
# 関連するファイルをステージング
git add src/components/UserProfile.tsx src/api/user.ts

# コミット作成
git commit -m "$(cat <<'EOF'
add: ユーザープロフィール編集機能を追加

フロントエンドのコンポーネントとバックエンドのAPIを実装。

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

### コミット分割の例

```bash
# 1つ目の変更をステージング
git add src/features/auth/

# 1つ目のコミット
git commit -m "$(cat <<'EOF'
add: ユーザー認証機能を追加

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"

# 2つ目の変更をステージング
git add docs/api.md

# 2つ目のコミット
git commit -m "$(cat <<'EOF'
docs: 認証APIのドキュメントを追加

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

## 注意事項

1. **コミットは明示的に要求された場合のみ作成する**
   - ユーザーが明示的に「コミットして」と言わない限り、コミットしない
   - これは非常に重要なルール

2. **コミットメッセージの品質を重視する**
   - 後で見返したときに理解できるメッセージを書く
   - チーム開発では他の開発者が理解できるように書く

3. **コミット履歴を汚さない**
   - 「WIP」や「test」などの一時的なコミットは避ける
   - 最終的なコミット履歴は読みやすく保つ

4. **HEREDOCを使用する**
   - 複数行のコミットメッセージはHEREDOCで記述する
   - これにより正確なフォーマットが保証される

5. **Co-Authored-Byを忘れない**
   - Claude Codeが関与したコミットには必ずCo-Authored-Byを追加する

## 関連ドキュメント

- [git-push.md](./git-push.md) - Git pushのルール
- [pull-request.md](./pull-request.md) - Pull Request作成のルール
